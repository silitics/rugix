[[systems]]
system = "customized-arm64"
ssh = { private-key = "./keys/id_rsa" }

[[steps]]
action = "run"
description = "adding an index to the `system-a` slot"
script = """
#!/bin/bash
set -euo pipefail
rugix-ctrl slots create-index system-a casync-64 sha512-256
if [ ! -e /run/rugix/mounts/data/rugix/slots/system-a/casync-64_sha512-256.rugix-block-index ]; then
    echo "Block index has not been created."
    exit 1
fi
"""

[[steps]]
action = "run"
description = "check system state prior to update"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "a"
"""

[[steps]]
action = "run"
description = "install a system update"
stdin-file = "./build/customized-arm64-delta/system.rugixb"
# Rebooting may cause the SSH client to disconnect while executing the script.
may-disconnect = true
script = """
#!/bin/bash
set -euo pipefail
cp /dev/stdin /var/www/html/system.rugixb
chmod 777 /var/www/html/system.rugixb
rx_before=$(< /sys/class/net/lo/statistics/rx_bytes)
tx_before=$(< /sys/class/net/lo/statistics/tx_bytes)
/usr/bin/time -v rugix-ctrl update install --reboot no http://localhost/system.rugixb
rx_after=$(< /sys/class/net/lo/statistics/rx_bytes)
tx_after=$(< /sys/class/net/lo/statistics/tx_bytes)
rx_delta=$((rx_after - rx_before))
tx_delta=$((tx_after - tx_before))
echo "=== Network usage on loopback (lo) ==="
echo "Received:    $rx_delta bytes"
echo "Transmitted: $tx_delta bytes"
echo "Total:       $((rx_delta + tx_delta)) bytes"
rugix-ctrl system reboot --spare
"""

[[steps]]
action = "wait"
duration = 10

[[steps]]
action = "run"
description = "check whether the update has been installed"
script = """
#!/bin/bash
set -euo pipefail
rugix-system-assert ".boot.defaultGroup" "a"
rugix-system-assert ".boot.activeGroup" "b"
rugix-ctrl system commit
rugix-system-assert ".boot.defaultGroup" "b"
rugix-system-assert ".boot.activeGroup" "b"
"""
